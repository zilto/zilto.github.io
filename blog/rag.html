<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">Retrieval augmented generation (RAG) with Streamlit, FastAPI, Weaviate, and Hamilton! | More is more</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://tjean.me/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://tjean.me/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://tjean.me/blog/rag"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Retrieval augmented generation (RAG) with Streamlit, FastAPI, Weaviate, and Hamilton! | More is more"><meta data-rh="true" name="description" content="Off-the-shelf LLMs are excellent at manipulating and generating text, but they only know general facts about the world and probably very little about your use case. Retrieval augmented generation (RAG) refers not to a single algorithm, but rather a broad approach to provide relevant context to an LLM. As industry applications mature, RAG strategies will be tailored case-by-case to optimize relevance, business outcomes, and operational concerns."><meta data-rh="true" property="og:description" content="Off-the-shelf LLMs are excellent at manipulating and generating text, but they only know general facts about the world and probably very little about your use case. Retrieval augmented generation (RAG) refers not to a single algorithm, but rather a broad approach to provide relevant context to an LLM. As industry applications mature, RAG strategies will be tailored case-by-case to optimize relevance, business outcomes, and operational concerns."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-09-08T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/zilto"><meta data-rh="true" property="article:tag" content="Hamilton,Retrieval augmented generation,OpenAI,LLM,FastAPI,Docker"><link data-rh="true" rel="icon" href="/img/icon.png"><link data-rh="true" rel="canonical" href="https://tjean.me/blog/rag"><link data-rh="true" rel="alternate" href="https://tjean.me/blog/rag" hreflang="en"><link data-rh="true" rel="alternate" href="https://tjean.me/blog/rag" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://tjean.me/blog/rag","mainEntityOfPage":"https://tjean.me/blog/rag","url":"https://tjean.me/blog/rag","headline":"Retrieval augmented generation (RAG) with Streamlit, FastAPI, Weaviate, and Hamilton!","name":"Retrieval augmented generation (RAG) with Streamlit, FastAPI, Weaviate, and Hamilton!","description":"Off-the-shelf LLMs are excellent at manipulating and generating text, but they only know general facts about the world and probably very little about your use case. Retrieval augmented generation (RAG) refers not to a single algorithm, but rather a broad approach to provide relevant context to an LLM. As industry applications mature, RAG strategies will be tailored case-by-case to optimize relevance, business outcomes, and operational concerns.","datePublished":"2023-09-08T00:00:00.000Z","author":{"@type":"Person","name":"Thierry Jean","url":"https://github.com/zilto","image":"https://github.com/zilto.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://tjean.me/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="MoreIsMore RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="MoreIsMore Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title="MoreIsMore JSON Feed">




<link rel="alternate" type="application/rss+xml" href="/til/rss.xml" title="Today I Learned RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/til/atom.xml" title="Today I Learned Atom Feed">
<link rel="alternate" type="application/json" href="/til/feed.json" title="Today I Learned JSON Feed"><link rel="stylesheet" href="/assets/css/styles.17e17681.css">
<script src="/assets/js/runtime~main.2e261347.js" defer="defer"></script>
<script src="/assets/js/main.fcc77f0d.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/icon.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/icon.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">More is more</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/til">TIL</a></div><div class="navbar__items navbar__items--right"><a href="https://www.linkedin.com/in/thierry-jean/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Let&#x27;s connect<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/zilto" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2023</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/rag">Retrieval augmented generation (RAG) with Streamlit, FastAPI, Weaviate, and Hamilton!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/pdf-summarizer">Containerized PDF Summarizer with FastAPI and Hamilton</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/feast-hamilton">Featurization: Integrating Hamilton with Feast</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/prefect-hamilton">Simplify Prefect Workflow Creation and Maintenance with Hamilton</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/modular-llm">Building a maintainable and modular LLM application stack with Hamilton</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/airflow-hamilton">Simplify Airflow DAG Creation and Maintenance with Hamilton</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2022</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/perks-of-hamilton">The perks of creating dataflows with Hamilton</a></li></ul></div></nav></aside><main class="col col--7"><article><header><h1 class="title_f1Hy">Retrieval augmented generation (RAG) with Streamlit, FastAPI, Weaviate, and Hamilton!</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-09-08T00:00:00.000Z">September 8, 2023</time> · <!-- -->19 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/zilto" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/zilto.png" alt="Thierry Jean"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/zilto" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Thierry Jean</span></a></div><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>Off-the-shelf LLMs are excellent at manipulating and generating text, but they only know general facts about the world and probably very little about your use case. Retrieval augmented generation (RAG) refers not to a single algorithm, but rather a broad approach to provide relevant context to an LLM. As industry applications mature, RAG strategies will be tailored case-by-case to optimize relevance, business outcomes, and operational concerns.</p>
<p><img decoding="async" loading="lazy" alt="Alt text" src="/assets/images/image-69d8bcd6fcc2be80b633fc87e3772d5b.png" width="1456" height="1115" class="img_ev3q"></p>
<blockquote>
<p>crosspost from <a href="https://blog.dagworks.io/p/retrieval-augmented-generation-reference-arch" target="_blank" rel="noopener noreferrer">https://blog.dagworks.io/p/retrieval-augmented-generation-reference-arch</a></p>
</blockquote>
<p>In this post, we provide a reference RAG architecture and discuss design decisions for each component. It’s ready for use, and will scale with your needs. Specifically, we’ll cover how to:</p>
<ul>
<li>Write ingestion and retrieval dataflows using <a href="https://hamilton.dagworks.io/en/latest/" target="_blank" rel="noopener noreferrer">Hamilton</a></li>
<li>Build a backend with <a href="https://fastapi.tiangolo.com/" target="_blank" rel="noopener noreferrer">FastAPI</a> + Hamilton backend</li>
<li>Create a browser interface with <a href="https://docs.streamlit.io/" target="_blank" rel="noopener noreferrer">Streamlit</a></li>
<li>Compute embeddings and generate text with the <a href="https://platform.openai.com/docs/api-reference/introduction" target="_blank" rel="noopener noreferrer">OpenAI API</a></li>
<li>Use and manage a <a href="https://weaviate.io/developers/weaviate" target="_blank" rel="noopener noreferrer">Weaviate</a> vector store</li>
<li>Build a containerized app using <a href="https://docs.docker.com/reference/" target="_blank" rel="noopener noreferrer">Docker</a></li>
</ul>
<blockquote>
<p>Find the code on <a href="https://github.com/DAGWorks-Inc/hamilton/tree/main/examples/LLM_Workflows/retrieval_augmented_generation" target="_blank" rel="noopener noreferrer">GitHub</a>
This publication extends our previous <a href="https://blog.dagworks.io/p/containerized-pdf-summarizer-with" target="_blank" rel="noopener noreferrer">PDF Summarizer</a></p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-rag-and-why-do-you-need-it">What is RAG and why do you need it?<a href="#what-is-rag-and-why-do-you-need-it" class="hash-link" aria-label="Direct link to What is RAG and why do you need it?" title="Direct link to What is RAG and why do you need it?">​</a></h2>
<p>Large language models (LLMs) learn to write coherent sentences by being exposed to enormous corpora of texts. In the process, the model stores facts about the world. However, determining what it knows or what it doesn’t is still a key theoretical challenge. The above generally describes <em>pre-trained</em>, <em>foundational</em> or <em>base</em> models, which are models not yet refined for a particular use-case (see model card of <a href="https://huggingface.co/bert-base-uncased" target="_blank" rel="noopener noreferrer">bert-base-uncased</a> for details). For instance, GPT stands for <em>generative pre-trained transformer</em>, and ChatGPT is a fine-tuned version for chat applications.</p>
<p>A primary concern for LLM applications, outside of creative work, is the factual correctness of answers. This challenge can be mitigated by adopting one or many of the following techniques:</p>
<ul>
<li>
<p><strong>Fine-tuning</strong> consists of further training a pre-trained model on curated examples for a specific task. The model learns domain-specific language and facts*, which improves the quality of embeddings and text generation relative to the domain (e.g., insurance, health).</p>
</li>
<li>
<p><strong>Instruction-tuning</strong> is a form of fine-tuning that uses instruction-answer pairs. The model learns <em>how</em> to respond to queries (summarize, make a list, think step by step, etc.). Models labeled as <em>chat</em> (e.g., <a href="https://huggingface.co/meta-llama/Llama-2-7b-chat" target="_blank" rel="noopener noreferrer">llama-2-7b-chat</a>) are great for general human interaction, and can be further fine-tuned to your domain.</p>
</li>
<li>
<p><strong>Retrieval augmented generation (RAG)</strong> is a multistep process to retrieve information relevant for a query, and pass it to the LLM as context to generate an answer. RAG is the most flexible approach for adding and updating knowledge since it only requires to change the available sources (e.g., files, internet pages) rather than updating the LLM.</p>
</li>
</ul>
<p>Looking forward, retrieval will continue to be a key architectural component of LLM applications because editing LLM knowledge directly is an unsolved problem. Fine-tuning, in most cases, should be a later concern since it would also improve your RAG strategy if you have one in place. Furthermore, the LLM is the most likely component to be improved upon and replaced, requiring fine-tuning again. For these reasons, we suggest starting with an off-the-shelf LLM and implementing your own RAG system as a first step to improve the knowledge your LLM operates over.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introducing-hamilton">Introducing Hamilton<a href="#introducing-hamilton" class="hash-link" aria-label="Direct link to Introducing Hamilton" title="Direct link to Introducing Hamilton">​</a></h2>
<p><a href="https://hamilton.dagworks.io/en/latest/" target="_blank" rel="noopener noreferrer">Hamilton</a> is a declarative micro-framework to describe <a href="https://en.wikipedia.org/wiki/Dataflow" target="_blank" rel="noopener noreferrer">dataflows</a> in Python. Its strength is expressing the flow of data and computation in a straightforward and easy to maintain manner (much like dbt does for SQL). It has minimal dependencies and can run anywhere Python runs, meaning the same code will work in development notebooks, scripts, Spark clusters, or production web-services. Hamilton is not a new framework (3.5+ years old), and has been used for years in production modeling data &amp; machine learning dataflows; and it extends nicely to modeling LLM workflows!</p>
<p><img decoding="async" loading="lazy" alt="Alt text" src="/assets/images/image-1-7516bf8851da2dedbffb09aebb4067a0.png" width="1037" height="682" class="img_ev3q"></p>
<p>The picture above encapsulates the function-centric declarative approach of Hamilton. The function’s name is tied to its outputs and its arguments define what data it depends on. This allows Hamilton to read functions found in a module and automatically generate the DAG to be executed. This paradigm incentivizes developers to write small modular functions instead of scripts or larger functions, without sacrificing iteration speed.</p>
<p>As a result, it is easier to:</p>
<ul>
<li>Write and maintain custom application logic</li>
<li>View operation lineage and debug results</li>
<li>Update components of your stack</li>
<li>Reuse function implementations across contexts (e.g., notebook, pipeline, web service)</li>
</ul>
<blockquote>
<p>If you are new to Hamilton, feel free to visit our interactive browser demo at
<a href="https://www.tryhamilton.dev/" target="_blank" rel="noopener noreferrer">https://www.tryhamilton.dev/</a></p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="building-a-modular-rag-application">Building a modular RAG application<a href="#building-a-modular-rag-application" class="hash-link" aria-label="Direct link to Building a modular RAG application" title="Direct link to Building a modular RAG application">​</a></h2>
<p><img decoding="async" loading="lazy" alt="Alt text" src="/assets/images/image-2-f3315f9fb72a623c8af50b067c4f2bdf.png" width="981" height="671" class="img_ev3q"></p>
<p>Our example RAG application allows users to import PDF files, extract and store the text chunks, and query the system. These different operations are implemented as dataflows with Hamilton and are exposed via FastAPI endpoints. The backend communicates with OpenAI to embed documents and generate answers, and uses a local Weaviate vector store instance to store and retrieve documents. The frontend is built with Streamlit and exposes the different functionalities via a simple web user interface (UI). Everything is packaged as containers with <code>docker compose</code>, so you can run it anywhere Docker runs.</p>
<blockquote>
<p>Find the example on <a href="https://github.com/DAGWorks-Inc/hamilton/tree/main/examples/LLM_Workflows/retrieval_augmented_generation" target="_blank" rel="noopener noreferrer">GitHub</a></p>
</blockquote>
<p>Let’s walk through its structure:</p>
<div class="language-title=&quot;Directory language-title=&quot;directory codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-title=&quot;directory codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── README.md</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── .env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── build_app.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── docker-compose.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── requirements.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── __init__.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── ingestion.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── retrieval.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── server.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── vector_db.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── docs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       ├── documents.png</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       ├── rag_summary.png</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       ├── store_arxiv.png</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └── store_pdfs.png</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── frontend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── requirements.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── assets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   └── hamilton_logo.png</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── __init__.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── client.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── Information.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └── pages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├── 1_Ingestion.py</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        └── 2_Retrieval.py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The repository is divided between the backend and the frontend, each with their own <code>Dockerfile</code> and <code>requirements.txt</code>. The backend has <code>server.py</code> which defines the FastAPI endpoints, and several <code>.py</code> files containing the Hamilton functions for the RAG workflow that interact with the vector store. You can think of each of these modules analogous to “chains” you’d find in Langchain. The frontend has <code>client.py</code> which handles <code>HTTP</code> requests to the backend and a <a href="https://docs.streamlit.io/library/get-started/multipage-apps/create-a-multipage-app" target="_blank" rel="noopener noreferrer">multipage Streamlit app</a> using <code>Information.py</code>, <code>pages/1_Ingestion.py</code>, and <code>pages/2_Retrieval.py</code>.  The file <code>Introduction.py</code> is the app entrypoint and landing page (it’s not the clearest file name, but it defines how the page will be displayed within the Streamlit UI).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="hamilton-dataflows-aka-chains">Hamilton dataflows a.k.a. “chains”<a href="#hamilton-dataflows-aka-chains" class="hash-link" aria-label="Direct link to Hamilton dataflows a.k.a. “chains”" title="Direct link to Hamilton dataflows a.k.a. “chains”">​</a></h2>
<p>A RAG application can be divided into 3 main steps: ingestion, retrieval, and generation. Importantly, the ingestion step can be done at any time (e.g., continuously, periodically in batch, event-driven) while retrieval and generation always happen together in our case, i.e., when a user makes a query. For this reason, we implemented ingestion in <code>ingestion.py</code> and retrieval + generation in <code>retrieval.py</code>. This way, it would be trivial to reuse our Hamilton ingestion code in a macro-orchestrated pipeline for daily updates of, for example, any newly stored documents; see how to use Hamilton with <a href="/2023-06-28-airflow-hamilton">Airflow</a>, <a href="/2023-07-25-prefect-hamilton">Prefect</a> for ideas on how that would work.</p>
<p>Also, you’ll notice a separate <code>vector_db.py</code> which implements a small set of functionalities to interact with Weaviate. These functions are quite simple, but it allows us to integrate our vector store operations to the broader dataflow, have granular visibility over operations, and handle exceptions. It also enables use to replace Weaviate easily if we wanted to choose another vector store. See <a href="/2023-07-11-modular-llm">our modular LLM stack post</a> for more details on how to do that.</p>
<blockquote>
<p>Below we’ll discuss our dataflow design decisions, for a more hands-on explanation of Hamilton, see our <a href="/2023-08-18-pdf-summarizer">PDF Summarizer example</a>.</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ingestion-flow">Ingestion flow<a href="#ingestion-flow" class="hash-link" aria-label="Direct link to Ingestion flow" title="Direct link to Ingestion flow">​</a></h3>
<p>The ingestion flow allows users to upload arbitrary PDF documents, extract text content, chunk it, get embeddings from OpenAI, and store text chunks with their embedding in Weaviate. To make this demo more engaging, we added functionalities to directly search <a href="https://arxiv.org/" target="_blank" rel="noopener noreferrer">arxiv.org</a> and store the selected scientific articles.</p>
<p>Below is the DAG for <code>ingestion.py</code>
<img decoding="async" loading="lazy" alt="Alt text" src="/assets/images/image-3-de79033c13d93f574841d88b5155715d.png" width="1118" height="1349" class="img_ev3q"></p>
<p>Nodes with dotted outlines and the <code>Input:</code> prefix are external to the <code>ingestion.py</code> module and need to be provided to the <code>Hamilton Driver</code> as inputs at execution time. Doubled lines and the different arrow types describe <a href="https://hamilton.dagworks.io/en/latest/concepts/hamilton-function-structure/#dynamic-dags" target="_blank" rel="noopener noreferrer">parallelizable code paths</a>, which can be used to improve processing performance. Towards the bottom, <code>pdf_collection</code> collects all the chunks and stores them in a single <a href="https://weaviate.io/developers/weaviate/tutorials/schema" target="_blank" rel="noopener noreferrer">structured object in Weaviate</a>.</p>
<p>Notice the path <code>local_pdfs</code> (near the center of the image) is part of; everything above is arXiv specific, and below is generic. This design decision allows us to reuse the same logic to store  PDFs from arXiv as any other PDF. As our application grows, we could store the arxiv functions in a separate <code>arxiv.py</code> module, and add code upstream of <code>local_pdfs</code> to load files from other sources. For example, you can visually imagine “cutting” the above diagram at <code>local_pdfs</code>, and then swapping in a different “implementation”, i.e. dataflow.</p>
<p>Also, we don’t do any sophisticated text processing, but we could easily add more functions between <code>raw_text</code> and <code>chunked_text</code>. By removing irrelevant text from PDFs (e.g., article references, markdown tables), we could reduce the amount of tokens to process, send to OpenAI, and to then store in our vector store. Adopting a smart processing strategy will both improve the quality of retrieval and lead to performance and cost optimization at scale.</p>
<p>Changes to the ingestion dataflow (e.g., preprocessing, chunking, embedding model) should generally be followed by reprocessing all documents and recomputing embeddings. Visualizing downstream dependencies of changes is helpful to prevent breaking changes. For example, changing the embedding model will make stored documents incompatible by changing the notion of distance for retrieval and possibly having incompatible vector dimensions. Using the <a href="https://weaviate.io/developers/weaviate/configuration/backups" target="_blank" rel="noopener noreferrer">Weaviate backup features</a> can make rollbacks easier and prevent having to re-compute embeddings and summaries, saving dollars and headaches.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="retrieval-flow">Retrieval flow<a href="#retrieval-flow" class="hash-link" aria-label="Direct link to Retrieval flow" title="Direct link to Retrieval flow">​</a></h3>
<p>The retrieval flow can appear complicated at first, but essentially it starts by getting the text embedding for the user query and doing a <a href="https://weaviate.io/developers/academy/zero_to_mvp/queries_2/hybrid" target="_blank" rel="noopener noreferrer">hybrid search</a> in Weaviate to find the most relevant stored chunks. For each chunk, it checks if a text summary was already generated; if not, the chunk is passed with a prompt to OpenAI’s chat model to generate a summary. The generated summaries of all chunks are collected and sorted according to the original Weaviate relevance ranking, to then be sent again to OpenAI to “reduce” summaries, i.e., make a summary of summary.</p>
<p>Here is the DAG for retrieval.py
<img decoding="async" loading="lazy" alt="Alt text" src="/assets/images/image-4-af39b77cbdec1eb458868cd45e206917.png" width="1456" height="768" class="img_ev3q"></p>
<p>A key decision was to specify prompt templates as function nodes (e.g., <code>prompt_to_summarize_chunk</code>, <code>prompt_to_reduce_summaries</code>) and not inputs (dotted outline). These prompt functions receive relevant context (e.g., text chunk), adds it to an f-string, and returns the formatted string. By storing them directly with the dataflow code, assessing behavior, versioning and debugging become much easier. We go into greater detail on how to manage prompts in <a href="https://blog.dagworks.io/p/llmops-production-prompt-engineering" target="_blank" rel="noopener noreferrer">LLMOps: Production prompt engineering patterns with Hamilton</a>.</p>
<p>As shown in the figure, the <code>rag_query</code> from the user only affects the initial chunk vector search and the <code>rag_summary</code> step which makes a “summary of summaries”. Accordingly, the function to summarize a chunk <code>chunk_with_new_summary</code> doesn’t depend on the user’s input allowing us to generate “generic” summaries for each chunk. This approach has the benefits of making chunk summaries reusable which can largely decrease cost and reduce latency. The downside is that the chunk summaries are less specific to the query and might decrease answer quality.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="weaviate-vector-database">Weaviate vector database<a href="#weaviate-vector-database" class="hash-link" aria-label="Direct link to Weaviate vector database" title="Direct link to Weaviate vector database">​</a></h3>
<p><a href="https://weaviate.io/developers/weaviate" target="_blank" rel="noopener noreferrer">Weaviate</a> offers a specialized type of infrastructure to efficiently store and compare text embeddings (i.e., vectors) at scale. In the context of RAG, the LLM represents the semantic of chunks of text as vectors, and the vector database defines the notion of similarity or relevance. Vector databases come in <a href="https://towardsdatascience.com/milvus-pinecone-vespa-weaviate-vald-gsi-what-unites-these-buzz-words-and-what-makes-each-9c65a3bd0696" target="_blank" rel="noopener noreferrer">various forms</a>, but we decided to use Weaviate for a few reasons:</p>
<ul>
<li>
<p><strong>Classes and structured objects</strong>. For each PDF, we create a <code>Document</code> object and <code>Chunk</code> objects and link them together with their respective properties <code>containsChunk</code> and <code>fromDocument</code>. With structured objects, we can retrieve a <code>Document</code> based on the relevance score of its <code>Chunks</code>; for example, by computing the <code>groupby sum</code> of the relevance of its chunks.</p>
</li>
<li>
<p><strong>Vectors and data in one place</strong>. Weaviate allows you to store the text along the vectors while other vector infrastructure only handle vectors. The latter requires managing and syncing a separate storage for documents which complexifies both ingestion and retrieval. Many data types are supported (e.g., strings, numbers, boolean, dates); we even store the full PDF of each <code>Document</code> as a <code>base64</code> blob.</p>
</li>
<li>
<p><strong>Expressive retrieval</strong>. Weaviate has a REST API for bulk operations and a GraphQL API for object retrieval. While learning GraphQL can be daunting, using it from the Python SDK is easy to approach (see example below). Additionally, many modes of retrieval are offered (vector, multimodal, keyword, etc.). For this RAG example, we used the <a href="https://weaviate.io/developers/weaviate/search/hybrid" target="_blank" rel="noopener noreferrer">hybrid search</a>, which combines vector and keyword search.</p>
</li>
</ul>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Weaviate GraphQL query</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">response </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    weaviate_client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;Chunk&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Class</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Properties to retrieve</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;chunk_index&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;content&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;summary&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;fromDocument {... on Document {_additional{id}}}&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Property of linked object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">with_hybrid</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># hybrid search parameters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        query</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">rag_query</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># user text query</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        properties</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;content&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># properties of `Chunk` to search on (specified above)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vector</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">query_embedding</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># user query embedding/vector</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        alpha</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">hybrid_search_alpha</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># hybrid search parameter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">with_additional</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;score&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># compute relevance score</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">with_limit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">retrieve_top_k</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># return top k objects</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">do</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fastapi-server">FastAPI server<a href="#fastapi-server" class="hash-link" aria-label="Direct link to FastAPI server" title="Direct link to FastAPI server">​</a></h3>
<p><a href="https://fastapi.tiangolo.com/" target="_blank" rel="noopener noreferrer">FastAPI</a> is used to define the server endpoints: <code>/store_arxiv</code>, <code>/store_pdfs</code>, <code>/rag_summary</code>, <code>/documents</code>, but for all of them, the code executed is actually handled by Hamilton. At startup, the server instantiates a <code>Hamilton Driver</code> with all the necessary Python modules (see <a href="https://fastapi.tiangolo.com/advanced/events/" target="_blank" rel="noopener noreferrer">FastAPI Lifespan Events</a>). Then, the function body of FastAPI endpoint consists of accessing the global <code>Hamilton Driver</code>, calling <code>Driver.execute()</code> with the necessary variables, and returning a formatted response. Using Hamilton guarantees that the code powering your web service will run identically to your development notebooks or orchestrated pipelines.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">FastAPI server snippet</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> contextlib </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> asynccontextmanager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> dataclasses </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> dataclass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> fastapi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> pydantic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> fastapi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">responses </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> JSONResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> hamilton </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># define a global dataclass that is shared across endpoints</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@dataclass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">GlobalContext</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector_db_url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hamilton_driver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@asynccontextmanager</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lifespan</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fastapi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FastAPI</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Startup and shutdown logic of the FastAPI app</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Above yield statement is at startup and below at shutdown</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Import the Hamilton modules and instantiate the Hamilton driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># import the Python modules containing your dataflows</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> ingestion</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> retrieval</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> vector_db</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    driver_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">enable_dynamic_execution</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">allow_experimental_mode</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># to allow Parallelizable/Collect</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">with_config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">driver_config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">with_modules</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ingestion</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> retrieval</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vector_db</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># pass our dataflows</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># make the variable global to reuse it within endpoints</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">global</span><span class="token plain"> global_context</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    global_context </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> GlobalContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vector_db_url</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;http://weaviate_storage:8083&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hamilton_driver</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">dr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># execute Hamilton code to make sure the Weaviate class schemas is instantiated</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    global_context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hamilton_driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;initialize_weaviate_instance&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inputs</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vector_db_url</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">global_context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vector_db_url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># anything above yield is executed at startup</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">yield</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># anything below yield is executed at teardown</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># instantiate the FastAPI app</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">app </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fastapi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FastAPI</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    title</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;Retrieval Augmented Generation with Hamilton&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lifespan</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">lifespan</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># pass the lifespan context</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># define a POST endpoint</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">post</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/store_arxiv&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tags</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;Ingestion&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">store_arxiv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arxiv_ids</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fastapi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Form</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> JSONResponse</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Retrieve PDF files of arxiv articles for arxiv_ids\n</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Read the PDF as text, create chunks, and embed them using OpenAI API\n</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Store chunks with embeddings in Weaviate.</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    global_context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hamilton_driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;store_documents&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inputs</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            arxiv_ids</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">arxiv_ids</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            embedding_model_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;text-embedding-ada-002&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            data_dir</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;./data&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            vector_db_url</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">global_context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vector_db_url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> JSONResponse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">content</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stored_arxiv_ids</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">arxiv_ids</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The snippet also shows that we execute the <code>Hamilton Driver</code> with <code>“initialize_weaviate_instance”</code> at startup to ensure the Weaviate schema exists and the vector store is available. Hamilton helps with keeping the endpoint functions brief and brings a nice separation of concerns. For example, if an error occurred, you can reproduce by using the logged request with Hamilton outside of FastAPI. If it succeeds, then the problem is likely related to the service and not the dataflow itself. We’ll discuss unit testing and integration testing in a future post, make sure to <a href="https://blog.dagworks.io/subscribe" target="_blank" rel="noopener noreferrer">subscribe</a> to be notified!</p>
<p>A core feature of Hamilton is the automatically generated DAG visualization, which complements FastAPI&#x27;s automated <a href="https://fastapi.tiangolo.com/tutorial/metadata/" target="_blank" rel="noopener noreferrer">Swagger UI documentation</a>. When running the example code, visit <a href="http://localhost:8082/docs" target="_blank" rel="noopener noreferrer">http://localhost:8082/docs</a> to explore it yourself! FastAPI allows you to <a href="https://fastapi.tiangolo.com/tutorial/schema-extra-example/" target="_blank" rel="noopener noreferrer">add request examples</a> to your code, which helps users learn your API and your team move faster as you develop and test things.</p>
<p><img decoding="async" loading="lazy" alt="Alt text" src="/assets/images/image-5-b51113d9f008e4d16e3d42d5da66e5cf.png" width="957" height="1194" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="streamlit-frontend">Streamlit frontend<a href="#streamlit-frontend" class="hash-link" aria-label="Direct link to Streamlit frontend" title="Direct link to Streamlit frontend">​</a></h3>
<p><a href="https://docs.streamlit.io/" target="_blank" rel="noopener noreferrer">Streamlit</a> allows you to build a user interface quickly using Python. Again, with the goal of modularity, we decided to build a <a href="https://docs.streamlit.io/library/get-started/multipage-apps/create-a-multipage-app" target="_blank" rel="noopener noreferrer">multipage Streamlit app</a> with independent pages for information, ingestion, and retrieval. The file <code>client.py</code> defines the HTTP requests to interact with the server, which helps errors related to the client-server communication from those associated with the UI. An important consideration when using Streamlit is that the entire code is executed whenever a page is refreshed, so avoid having operations that are computationally intensive or incur costs (e.g., LLM API calls).</p>
<p>The design of your search UI is a significant decision as it will largely <a href="https://www.algolia.com/blog/ux/7-examples-of-great-site-search-ui/" target="_blank" rel="noopener noreferrer">influence how people use your application</a>. For the ingestion page, we made sure to display the currently stored documents and provide feedback via a “spinner” widget during long ingestion operations. For the retrieval page, we exposed hybrid search parameters such as alpha and top k with informational tooltips to allow users to play around, but kept hidden the prompts used to summarize documents. After making a RAG query, the app will display the query, the answer, and the source chunks with their summary to allow you to reason over the answer. After more than one query, a slider will allow you to browse through your history of searches and compare answers to different queries. Semantic search has enabled news ways to retrieve information across documents, but finding the ideal UI for it remains an unsolved problem and we encourage you to iterate over it!</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="docker-services">Docker services<a href="#docker-services" class="hash-link" aria-label="Direct link to Docker services" title="Direct link to Docker services">​</a></h3>
<p>Here’s the <code>docker-compose.yaml</code> file that manages three containers:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">Docker compose file</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;3.4&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">api</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fastapi_server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">build</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> backend/.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;uvicorn server:app --host 0.0.0.0 --port 8082&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;8082:8082&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> OPENAI_API_KEY=$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">OPENAI_API_KEY</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> DAGWORKS_API_KEY=$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">DAGWORKS_API_KEY</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">networks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> rag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">app</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> streamlit_app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">build</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> frontend/.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;streamlit run --server.port 8080 --server.enableCORS false Information.py&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;8080:8080&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">networks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> rag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">weaviate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cr.weaviate.io/semitechnologies/weaviate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">1.19.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> weaviate_storage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">host 0.0.0.0 </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">port &#x27;8083&#x27; </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">scheme http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> 8083</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8083</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">restart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> on</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">failure</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">QUERY_DEFAULTS_LIMIT</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">25</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;true&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">PERSISTENCE_DATA_PATH</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/var/lib/weaviate&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">DEFAULT_VECTORIZER_MODULE</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;none&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">ENABLE_MODULES</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">CLUSTER_HOSTNAME</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;node1&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">networks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> rag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">networks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rag</span><span class="token punctuation" style="color:#393A34">:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This sets the main configuration of each service. For the FastAPI backend (api service), we pass the OpenAI key to the FastAPI backend and optionally set the DAGWorks API key. The Weaviate configuration is generated by their <a href="https://weaviate.io/developers/weaviate/installation/docker-compose" target="_blank" rel="noopener noreferrer">interactive tool</a>. Then, for each service the command section sets their entry point. They are all connected together via the <code>rag</code> <a href="https://docs.docker.com/network/drivers/bridge/" target="_blank" rel="noopener noreferrer">bridge network</a>. This allows services to communicate via a local URL of the following format <code>http://{container_name}:{port}</code> (e.g., <code>http://fastapi_server:8082</code>). You could want to have your vector store less tightly coupled if it is used by other applications.</p>
<p>When developing locally, containers can be accessed via<code> http://127.0.0.1:{port}</code> (try not to use <a href="https://www.youtube.com/watch?v=98SYTvNw1kw" target="_blank" rel="noopener noreferrer">localhost</a>). You can keep containers running and call <code>docker compose up -d –build</code> to rebuild them as you make changes. In particular, this is useful to view frontend UI changes and test backend changes manually via the Swagger UI at <a href="http://localhost:8082/docs" target="_blank" rel="noopener noreferrer">http://localhost:8082/docs</a>.  To see container logs, you can use <code>docker compose logs -f</code>  to see the logs from applications from their respective containers.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="limitations">Limitations<a href="#limitations" class="hash-link" aria-label="Direct link to Limitations" title="Direct link to Limitations">​</a></h2>
<p>This example aims to be a reference architecture, and demonstrate how to build a RAG system and give you a solid basis to start your own project. However, it is by no means perfect. Here’s a list of limitations or areas we could improve upon:</p>
<p><strong>arXiv downloads</strong>. The ingestion dataflow for arXiv files requires downloading the PDF of articles locally (on the FastAPI container) before subsequent steps. That is PDF files could fill up your docker container. A better approach would be to use the built-in <a href="https://docs.python.org/3/library/tempfile.html" target="_blank" rel="noopener noreferrer">tempfile library</a> for <code>tempfile.NamedTemporaryFile</code> (note that tempfile is an area of active Python development and saw several changes since 3.8). For instance, PDF files sent to FastAPI (via Streamlit or POST) use temporary files via <code>streamlit.runtime.UploadedFile</code> and <code>fastapi.Uploadfile</code>.</p>
<p><strong>Weaviate duplicates</strong>. Having duplicate sources in your vector store can reduce the quality of retrieval. You’d most likely prefer the “5 most-relevant, but somewhat distinct” chunks from the “5-most relevant and almost identical” chunks to generate your answer. However, the presented RAG system doesn’t prevent you from uploading duplicate documents during ingestion and finding duplicate / nearly files is a generally complex problem. One approach would be to first select the sets of chunks with very similar embeddings (potential duplicate) then use <a href="https://github.com/seatgeek/thefuzz" target="_blank" rel="noopener noreferrer">fuzzy matching</a> (which is much less computationally efficient) on the chunk’s text to score potential duplicates. The downside is that it requires compute and can impact latency having to do this for the embedding of every chunk before deduplication.</p>
<p><strong>REST API conventions</strong>. This example showcases a client-server architecture with the ingestion and retrieval of a RAG workflow. However, the design and the naming of the endpoints don’t follow the <a href="https://restfulapi.net/resource-naming/" target="_blank" rel="noopener noreferrer">REST best practices</a>. Following these conventions improves the semantics and the readability of your project, which is critical from proper downstream use. We will improve and update our API definition in our future post about testing. Make sure to subscribe to be notified when it we release it!</p>
<p><strong>Client-server communication</strong>. You could use <a href="https://docs.pydantic.dev/latest/" target="_blank" rel="noopener noreferrer">Pydantic</a> more extensively to define the FastAPI <a href="https://fastapi.tiangolo.com/tutorial/response-model" target="_blank" rel="noopener noreferrer">requests and response types</a>. This code could be used in both the <code>backend/server.py</code> and <code>frontend/client.py</code> to make development less error prone.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h2>
<p>We covered a lot in this post. Most importantly, we leave you with a reference architecture blueprint to get started with RAG applications. To use it, we suggest you should define your application’s dataflows, then create the endpoints for the operations supported by your server, and finally build the best-suited user interface for your application. Congratulations for getting through! Please bookmark this post, and feel free to revisit sections of this post as you make progress; if something isn’t clear please leave a comment/or suggest a PR to the repo to improve this example.</p>
<p>You might be interested by other posts in this series:</p>
<ul>
<li><a href="https://blog.dagworks.io/p/llmops-production-prompt-engineering" target="_blank" rel="noopener noreferrer">LLMOps: Production prompt engineering patterns with Hamilton</a></li>
<li><a href="/2023-07-11-modular-llm">Building a maintainable and modular LLM application stack with Hamilton</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="we-want-to-hear-from-you">We want to hear from you!<a href="#we-want-to-hear-from-you" class="hash-link" aria-label="Direct link to We want to hear from you!" title="Direct link to We want to hear from you!">​</a></h2>
<p>If you’re excited by any of this, or have strong opinions, leave a comment, or drop by our Slack channel! Some links to do praise/complain/chat:</p>
<p>📣 join our community on <a href="https://hamilton-opensource.slack.com/join/shared_invite/zt-1bjs72asx-wcUTgH7q7QX1igiQ5bbdcg#/shared-invite/email" target="_blank" rel="noopener noreferrer">Slack</a>  —  we’re more than happy to help answer questions you might have or get you started.</p>
<p>⭐️ us on <a href="https://github.com/dagworks-inc/hamilton" target="_blank" rel="noopener noreferrer">GitHub</a>.</p>
<p>📝 leave us an <a href="https://github.com/DAGWorks-Inc/hamilton/issues" target="_blank" rel="noopener noreferrer">issue</a> if you find something.</p>
<p>📚 read our <a href="https://hamilton.dagworks.io/en/latest/" target="_blank" rel="noopener noreferrer">documentation</a>.</p>
<p>⌨️ <a href="https://www.tryhamilton.dev/" target="_blank" rel="noopener noreferrer">interactively learn</a> about Hamilton in your browser.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/hamilton">Hamilton</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/retrieval-augmented-generation">Retrieval augmented generation</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/open-ai">OpenAI</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/llm">LLM</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/fast-api">FastAPI</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/docker">Docker</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/pdf-summarizer"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Containerized PDF Summarizer with FastAPI and Hamilton</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-is-rag-and-why-do-you-need-it" class="table-of-contents__link toc-highlight">What is RAG and why do you need it?</a></li><li><a href="#introducing-hamilton" class="table-of-contents__link toc-highlight">Introducing Hamilton</a></li><li><a href="#building-a-modular-rag-application" class="table-of-contents__link toc-highlight">Building a modular RAG application</a></li><li><a href="#hamilton-dataflows-aka-chains" class="table-of-contents__link toc-highlight">Hamilton dataflows a.k.a. “chains”</a><ul><li><a href="#ingestion-flow" class="table-of-contents__link toc-highlight">Ingestion flow</a></li><li><a href="#retrieval-flow" class="table-of-contents__link toc-highlight">Retrieval flow</a></li><li><a href="#weaviate-vector-database" class="table-of-contents__link toc-highlight">Weaviate vector database</a></li><li><a href="#fastapi-server" class="table-of-contents__link toc-highlight">FastAPI server</a></li><li><a href="#streamlit-frontend" class="table-of-contents__link toc-highlight">Streamlit frontend</a></li><li><a href="#docker-services" class="table-of-contents__link toc-highlight">Docker services</a></li></ul></li><li><a href="#limitations" class="table-of-contents__link toc-highlight">Limitations</a></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li><li><a href="#we-want-to-hear-from-you" class="table-of-contents__link toc-highlight">We want to hear from you!</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">© Copyright 2024, Thierry Jean. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>